# Amazon Personalize Monitor - Core Monitor Function

The [personalize_monitor.py](./personalize_monitor.py) Lambda is called every 5 minutes by a CloudWatch scheduled event rule to generate the CloudWatch metrics needed to populate the Personalize Monitor dashboard line graph widgets and to trigger the CloudWatch alarms for low campaign utilization and idle campaign detection (if configured). Also, if the `AutoDeleteIdleCampaigns` deployment parameter is `Yes` AND a monitored campaign has been idle more than `IdleCampaignThresholdHours` hours, this function will publish a `DeletePersonalizeCampaign` event to EventBridge that is handled by the [personalize_delete_campaign](../personalize_delete_campaign_function/) function.  An idle campaign is one that has not had any `GetRecommendations` or `GetPersonalizedRanking` calls in the last `IdleCampaignThresholdHours` hours. Finally, this function will adjust a campaign's `minProvisionedTPS` (down only) if the `AutoAdjustCampaignMinProvisionedTPS` deployment parameter is `Yes`.

## How it works

The function first determines what Personalize campaigns should be monitored based on the CloudFormation template parameters you specify when you [install](../README.md#installing-the-application) the application.

## CloudWatch Metrics

The following custom CloudWatch metrics are generated by this function on 5 minute intervals. You can find these metrics in the AWS console under CloudWatch and then Metrics or you can query them using the CloudWatch API.

| Namespace | MetricName | Dimensions | Unit | Description |
| --- | --- | --- | --- | --- |
| PersonalizeMonitor | monitoredCampaignCount | | Count | Number of campaigns currently being monitored at interval |
| PersonalizeMonitor | minProvisionedTPS | CampaignArn | Count/Second | `minProvisionedTPS` value for the campaign at interval |
| PersonalizeMonitor | averageTPS | CampaignArn | Count/Second | Average TPS for the campaign at interval |
| PersonalizeMonitor | campaignUtilization | CampaignArn | Percent | Utilization percentage of `averageTPS` vs `minProvisionedTPS` at interval |

### How is averageTPS calculated?

The `averageTPS` metric value for each monitored campaign is calculated by first determining the number of requests made to the campaign during the 5 minute interval and dividing by 300 (the number of seconds in 5 minutes). The number of requests is pulled from the `GetRecommendations` or `GetPersonalizedRanking` metric (depending on the recipe for the campaign's solution) for the campaign from the `AWS/Personalize` namespace. This metric is automatically updated by Personalize itself.

## CloudWatch Alarms (optional)

You can optionally have CloudWatch alarms dynamically created for monitored campaigns for low campaign utilization and idle campaigns.

### Low Campaign Utilization Alarm

If you set the `AutoCreateCampaignUtilizationAlarms` CloudFormation template parameter to `Yes` when you installed this application, this function will automatically create a CloudWatch alarm for every campaign that it monitors. The alarm will trigger when the `campaignUtilization` custom metric described above drops below the `CampaignThresholdAlarmLowerBound` installation parameter for 9 out of 12 evaluation periods. Since the intervals are 5 minutes, that means that 9 of the 12 five minute evaluations over a 60 minute span must be below the threshold to enter an alarm status. The same rule applies to transition from alarm to OK status. The alarm will be created in the region where the campaign was created. An [SNS](https://aws.amazon.com/sns/) topic created by this application will be used as the alarm and ok actions and the `NotificationEndpoint` (email address) deployment parameter will be setup as a subscriber to the topic. **Be sure to confirm the subscription sent when this application is deployed by clicking on the one-time confirmation email sent by SNS.** 

The alarm will have its actions disabled when the `minProvisionedTPS` is 1 and enabled with `minProvisionedTPS` is > 1 so that notifications are only sent when utilization can be impacted by adjusting `minProvisionedTPS`. 

### Idle Campaign Alarm

If you set the `AutoCreateIdleCampaignAlarms` CloudFormation template parameter to `Yes` when you installed this application, this function will automatically create a CloudWatch alarm for every monitored campaign that is idle for at least `IdleCampaignThresholdHours` hours. The actions for the alarm will be enabled only after the campaign has existed for `IdleCampaignThresholdHours` as well. The `GetRecommendations` or `GetPersonalizedRanking` (depending on the campaign's recipe) will be used to assess the campaign's idle state. The alarm will be created in the region where the campaign was created. An [SNS](https://aws.amazon.com/sns/) topic created by this application will be used as the alarm and ok actions and the `NotificationEndpoint` (email address) deployment parameter will be setup as a subscriber to the topic. **Be sure to confirm the subscription sent when this application is deployed by clicking on the one-time confirmation email sent by SNS.** 

## Automatically adjusting campaign minProvisionedTPS (optional)

If the `AutoAdjustCampaignMinProvisionedTPS` deployment parameter is `Yes`, this function will check the actual hourly TPS over the last 14 days against the currently configured `minProvisionedTPS` and look for opportunities to reduce the campaign's `minProvisionedTPS` to optimize utilization and reduce costs. It does this by checking the campaign's request volume for the previous 14 days on hourly intervals and finding the hour with the lowest average TPS (low watermark). If the low watermark average is less than the campaign's `minProvisionedTPS` AND the campaign is more than 1 day old, it will drop the `minProvisionedTPS` by 25%. This process will be repeated each hour until either the `minProvisionedTPS` meets the low watermark TPS or the `minProvisionedTPS` reaches 1 (the lowest allowed value). **This function will NOT increase the `minProvisionedTPS` for a campaign.** Instead it will rely on Personalize to auto-scale campaigns up and back down to `minProvisionedTPS` to meet demand. 

> Since it can take several minutes for a campaign to redeploy after updating its `minProvisionedTPS`, you will receive the notification when the redeploy starts. The campaign will continue to respond to `GetRecommendations`/`GetPersonalizedRanking` API requests while it is redeploying. There will be no interruption of service.

See the [personalize_update_campaign_tps](../personalize_update_campaign_tps_function/) function for details on the update function.

## Automatically deleting idle campaigns (optional)

If the `AutoDeleteIdleCampaigns` deployment parameter is `Yes`, this function will perform additional checks once per hour for each monitored campaign to see if it has been idle for more than `IdleCampaignThresholdHours` hours. The purpose of this feature is to prevent abandoned campaigns from continuing to incur costs when they are no longer being used. Campaign checks are distributed across each hour in 10 minute blocks in an attempt to spread out the API calls needed to check and update campaigns.

To avoid too aggressively deleting campaigns, new campaigns that are not more than `IdleCampaignThresholdHours` hours old are exempt from being deleted. Similarly, if a campaign has been updated within `IdleCampaignThresholdHours`, it will also be exempt from being automatically deleted. The idea is that new or actively updated campaigns are likely not safe to delete.  
